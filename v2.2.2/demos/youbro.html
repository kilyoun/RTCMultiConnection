<!--
#### TODO (kykim)
* ~~ Listing All Rooms ~~
* ~~ Listing All Participants ~~
* Auto broadcast start using uniq ID (Phone #, FB Email or XXX)
* Join randomly for rooms as swipe
* Host page 처리 - Remote 접속하는 애들 Grid로 보여주기
* Eject 했을때 깔끔하게 처리
-->

<!DOCTYPE html>
<html id="home" lang="en">

<head>
    <title>Users ejection and presence detection using RTCMultiConnection ® Muaz Khan</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">    
    <style>
    audio,
    video {
        -moz-transition: all 1s ease;
        -ms-transition: all 1s ease;
        -o-transition: all 1s ease;
        -webkit-transition: all 1s ease;
        transition: all 1s ease;
        vertical-align: top;
        width: 100%;
    }       
  
    .eject {
        background-image: url('https://www.webrtc-experiment.com/images/eject.png') !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        border-color: white;
        border-radius: 0;
        height: 30px;
        margin: .2em;
        position: absolute;
        width: 30px;
        z-index: 200;
    }

    .col-xs-4 {
        padding-right: 1px;
        padding-left: 0px;
    }
    </style>

    <script src="//cdn.webrtc-experiment.com/firebase.js"></script>
    <script src="//cdn.webrtc-experiment.com/RTCMultiConnection.js"></script>
</head>

<body>
    <div class="container body-content">
        <div class="row">
            <button id="start-new-session" class="btn btn-primary">New Session</button>
        </div>
        <div class="row">
            <div id="local-video-container">
            </div>
        </div>
        <div class="row">
            <div id="remote-videos-container">
            </div>
        </div>
        <div class="row">
            <table id="sessions-list" class="table table-condensed"></table>
        </div>
    </div>

    <script>
        // window.username = Math.random() * 9999 << 9999;
        var connection = new RTCMultiConnection();

        var sessionsList = document.getElementById('sessions-list');
        connection.onNewSession = function (session) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + session.extra.username + '</td>';
            var td = document.createElement('td');
            var button = document.createElement('button');
            button.innerHTML = 'join';
            td.appendChild(button);
            tr.appendChild(td);
            sessionsList.insertBefore(tr, sessionsList.firstChild);

            button.onclick = function () {
                if (!window.username) window.username = prompt('Please enter your username') || 'Anonymous';

                connection.extra = {
                    username: window.username
                };
                session.join();

                document.getElementById('start-new-session').disabled = true;
                sessionsList.style.display = 'none';
            };
        };

        // check if user is ejected
        // clear rooms-list if user is ejected
        connection.onSessionClosed = function (event) {
            if (event.isEjected) {
                sessionsList.innerHTML = '';
                sessionsList.style.display = 'block';
            }
        };

        document.getElementById('start-new-session').onclick = function () {
            if (!window.username) window.username = prompt('Please enter your username') || 'Anonymous';

            connection.extra = {
                username: window.username
            };

            connection.interval = 1000;
            connection.sessionid = window.username;
            console.log('window.username = ' + window.username);
            connection.open();

            document.getElementById('start-new-session').disabled = true;
            sessionsList.style.display = 'none';
        };

        connection.onstream = function (stream) {
            if (stream.type === 'local') {
                var video = getVideo(stream, {
                    username: window.username
                });
                document.getElementById('local-video-container').appendChild(video);
            }

            if (stream.type === 'remote') {
                var video = getVideo(stream, stream.extra);
                video.className += ' col-xs-4';  // Bootstrip Grid 시스템 (한줄에 3개씩)
                var remoteVideosContainer = document.getElementById('remote-videos-container');
                remoteVideosContainer.appendChild(video, remoteVideosContainer.firstChild);
            }
            stream.mediaElement.width = innerWidth / 3.4;
        };

        connection.onstreamended = function (e) {
            if (e.mediaElement && e.mediaElement.parentNode && e.mediaElement.parentNode.parentNode) {
                e.mediaElement.parentNode.parentNode.removeChild(e.mediaElement.parentNode);
            }
        };

        function getVideo(stream, extra) {
            var div = document.createElement('div');
            div.className = 'video-container';
            div.id = stream.userid || 'self';

            if (stream.type === 'remote')
            {
                if (connection.isInitiator) {
                    var eject = document.createElement('button');
                    eject.className = 'eject';
                    eject.title = 'Eject this User';

                    eject.onclick = function () {
                        // eject a specific user
                        connection.eject(this.parentNode.id);
                        this.parentNode.style.display = 'none';
                    };
                    div.appendChild(eject);
                }
            }

            var video = stream.mediaElement;
            div.appendChild(video);
            if (extra) {
                video.title = extra.username;
                var name = document.createElement('center');
                name.innerHTML = '<small>' + extra.username + '</small>';
                div.appendChild(name);
            }

            return div;
        }

        connection.connect();
    </script>

</body>

</html>